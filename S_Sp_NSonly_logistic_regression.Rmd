---
title: "Sensitivity/Specificity Analyses - Canine Leishmaniosis"
author: "Marie Ozanne"
date: "February 27, 2020"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
# library(actuar)
library(coda)
library(egg)
library(ggplot2)
library(R2OpenBUGS)
# library(GGally)
library(summarytools)
```

# Exploratory Analyses

```{r exploratory, echo=FALSE}
setwd("G:/My Drive/Research/Sensitivity_Specificity/")
ss_data <- read.csv("Data/DPPReaderData_cleaned_alldata_final.csv", na.strings = c("NA", "", "."))
ss_data <- ss_data[,!(names(ss_data)%in%c("X", "X.1", "X.2", "X.3"))] ## remove columns with comments only
names(ss_data) <- c(names(ss_data)[1:4], "PCR", "PCR_positive",
                    "DPP", "DPP_positive", "ClinicalStatus")

## For analysis purposes - treat all observations as independent and 'Timepoint' is irrelevant
## Clinical Status (based on 2 or more clinical symptoms): N=negative, A=asymptomatic, S=symptomatic

ss_data[which(ss_data$ClinicalStatus=="AS"),]$ClinicalStatus <- "A" ## replace AS with A for consistency
ss_data[which(ss_data$ClinicalStatus=="SY"),]$ClinicalStatus <- "S" ## replace SY with S for consistency

## drop unused levels from Clinical Status
ss_data$ClinicalStatus <- droplevels(ss_data$ClinicalStatus)

## "F" and "M" erroneously places in Age column
ss_data$Age[which(ss_data$Age=="F")] <- NA
ss_data$Age[which(ss_data$Age=="M")] <- NA
ss_data$Age <- as.numeric(ss_data$Age)

## One pup has PCR as positive - moving this indication to the PCR_positive
## column, which currently has an NA
ss_data[is.na(ss_data$PCR_positive),]$PCR_positive <- "Positive"

## Standardize the levels for PCR_positive
## Current levels: > levels(ss_data$PCR_positive)
#  [1] "BL"                         "BL (single 1:10 well only)" "BL below threshold"   
#  [4] "N"                          "Neg"                        "negative"     
#  [7] "Negative"                   "P"                          "pos"       
# [10] "Pos"                        "positive"                   "Positive"  
### Assume all BL (below limits) are "Negative"
ss_data[ss_data$PCR_positive=="BL",]$PCR_positive <- "Negative"
ss_data[ss_data$PCR_positive=="BL (single 1:10 well only)",]$PCR_positive <- "Negative"
ss_data[ss_data$PCR_positive=="BL below threshold",]$PCR_positive <- "Negative"
ss_data[ss_data$PCR_positive=="N",]$PCR_positive <- "Negative"
ss_data[ss_data$PCR_positive=="Neg",]$PCR_positive <- "Negative"
ss_data[ss_data$PCR_positive=="negative",]$PCR_positive <- "Negative"

### Standardize all positive entries to "Positive"
ss_data[ss_data$PCR_positive=="P",]$PCR_positive <- "Positive"
ss_data[ss_data$PCR_positive=="pos",]$PCR_positive <- "Positive"
ss_data[ss_data$PCR_positive=="Pos",]$PCR_positive <- "Positive"
ss_data[ss_data$PCR_positive=="positive",]$PCR_positive <- "Positive"

## drop unused levels from PCR_positive
ss_data$PCR_positive <- droplevels(ss_data$PCR_positive)

## One pup had "positive" in the PCR column, which should be numeric
## replace with NA - no numerical value available
ss_data$PCR[which(ss_data$PCR=="positive")] <- NA

## Change PCR to numeric
ss_data$PCR <- as.numeric(ss_data$PCR)

## Print summary of data
# summary(ss_data[,!(names(ss_data) %in% c("Timepoint", "ID"))])

## Create new DPP_positive variable based on reader cutoffs (>9.9 is positive)
ss_data$DPP_positive2 <- ifelse(ss_data$DPP > 9.9,
                                c("Positive"), c("Negative"))

## Omit missing values
ss_data_nao <- na.omit(ss_data[,names(ss_data) %in% c("Sex", "Age", "DPP",
                                                      "ClinicalStatus",
                                                      "DPP_positive",
                                                      "PCR_positive",
                                                      "DPP_positive2")])

## Create contingency table for data we are using:
ss_data2 <- ss_data_nao[ss_data_nao$ClinicalStatus!="A",]
ss_data2$DPP_positive2 <- as.factor(ss_data2$DPP_positive2)
table(PCR=ss_data2$PCR_positive, DPP=ss_data2$DPP_positive2)

## Include variable for diagnostically positive (positive on at least one test)
ss_data2$Diagnostically_positive <- rep(NA, nrow(ss_data2))
ss_data2[ss_data2$PCR_positive == "Positive" | ss_data2$DPP_positive2 == "Positive",]$Diagnostically_positive <- "Positive"
ss_data2[ss_data2$PCR_positive == "Negative" & ss_data2$DPP_positive2 == "Negative",]$Diagnostically_positive <- "Negative"
```

# Models

Angela's paper (Toepp et al., 2019, https://doi.org/10.1371/journal.pntd.0007058) uses logistic regression, with age, sex, and variables that have to do with diagnostic tests as explanatory variables. They are something like this:  

**Model A 1:** $logit(\pi_k)=\beta_0+\beta_1Age_k + \beta_2Sex_k + \beta_3 Y_k$, where $Y_k$ is diagnostically positive (as defined in Model 1 below), but for the mom and $\pi_k$ is the probability of disease for individual $k$

**Model A 2:** $logit(\pi_k)=\beta_0+\beta_1Age_k + \beta_2Sex_k + \beta_3 T_{1k} + \beta_4T_{2k}$, where $T_{jk}$ is the result for Test $j$ (as defined in Model 1 below), but for the mom and $\pi_k$ is the probability of disease for individual $k$

Note, these models were fit with a log link function, presumably so that relative risks could be recovered?

We plan to evaluate similar models for our data and to then incorporate sensitivity and specificity of the tests into these models. Then we will compare the model performance to that of other methods. Hopefully we will see an improvement/some details that we miss when we do not include the sensitivity and specificity for the tests.

In all these models, we will assume that the observations are independent.

## Model 1:

### Data Model

$$
T_{1k}|D_k \sim Bernoulli(\pi_{1k})
$$
where $\pi_{1k}=P(T_{1k}=1|D_k)=D_k\times \underbrace{P(T_{1k}=1|D_k=1)}_{sensitivity}+(1-D_k)\times \underbrace{(1-P(T_{1k}=0|D_k=0))}_{1-specificity}$.
$$
T_{2k}|D_k \sim Bernoulli(\pi_{2k})
$$
where $\pi_{2k}=P(T_{2k}=1|D_k)=D_k\times \underbrace{P(T_{2k}=1|D_k=1)}_{sensitivity}+(1-D_k)\times \underbrace{(1-P(T_{2k}=0|D_k=0))}_{1-specificity}$.

### Process Model

$$
D_k \sim Bernoulli(\delta_k)
$$
where $\delta_k=logit^{-1}(logit(\rho)+\mathbf{x}_k^T\boldsymbol{\beta})$.

### Prior Model

#### Prevalence
$$
logit(\rho) \sim Normal(\mu_{\rho}, \tau^2)
$$
where $\mu_\rho=logit^{-1}(\rho^*)$ and $\tau^2=$...

We have a range for the prevalence of (0.05, 0.10). This corresponds to a range of (`r round(log(0.05)/(1-log(0.05)),4)`, `r round(log(0.10)/(1-log(0.10)),4)`) on the logit scale. 

```{r}
hist(rnorm(10000, mean = log(0.075)/(1-log(0.075)), sd = 0.03),
     main="Logit prevalence prior distribution histogram",
     xlab="logit(prevalence)")
```

Note, the prevalence in this population may be higher - these are exposed dogs in the United States in our hunting hound population. We may want to change this, but we also want to generalize this to the larger canine population - to Brazil, if possible.

#### Linear predictors

The regression parameters are $\boldsymbol{\beta}=(\beta_{age},\beta_{sex},\beta_{age*sex})^T$;

$$
\boldsymbol{\beta}\sim Normal(\boldsymbol{\mu}_\beta,\boldsymbol{\Sigma}_\beta)
$$
where $\boldsymbol{\mu}_\beta=\mathbf{0}$ and $\boldsymbol{\Sigma}_\beta=\mathbf{I}$ in our code. 




```{r Open Bugs setup}
## ranges of sensitivities and specificities
sens.pcr.range <- c(0.839, 0.990)
sens.dpp.range <- c(0.832, 0.930)
spec.pcr.range <- c(0.871, 0.970)
spec.dpp.range <- c(0.682, 0.951)

sens.pcr <- mean(sens.pcr.range)
sens.dpp <- mean(sens.dpp.range)
spec.pcr <- mean(spec.pcr.range)
spec.dpp <- mean(spec.dpp.range)

## range of prevalence for visceral leishmaniasis
prev.range <- c(0.05,0.10)
prev <- mean(prev.range)
```

### OpenBUGS Model 1 Implementation

```{r Open Bugs Model 1, include=FALSE, message=FALSE}
## Specify data
y.pcr <- 1*(ss_data2$PCR_positive=="Positive")
y.dpp <- 1*(ss_data2$DPP_positive2=="Positive")

nind <- nrow(ss_data2)

Sex2 <- 1*(ss_data2$Sex=="M")
Age <- as.numeric(ss_data2$Age)

data <- list(nind=nind,
             y.pcr=y.pcr,
             y.dpp=y.dpp,
             Sex=Sex2,
             Age=Age,
             sens.pcr=sens.pcr,
             spec.pcr=spec.pcr,
             sens.dpp=sens.dpp,
             spec.dpp=spec.dpp,
             prev=prev,
             prec.lpi=1/0.03
)

## Initialize all prior values
inits <- function(){
  list(lpi=rnorm(1,log(prev)/(1-log(prev)), 0.03),
       b1=rnorm(0,1),
       b2=rnorm(0,1),
       b3=rnorm(0,1))
}

## Start MCMC simulation
sens_spec.sim_m1 <- bugs(data=data, 
                      inits=inits, ## FIX THIS LINE
                      model.file="Model1_separate_tests_GB.txt",
                      parameters=c("D", "lpi", 
                                   "b1", "b2", "b3"),
                      n.chains=3, n.iter=10000, n.burnin=5000, 
                      codaPkg=TRUE, debug=TRUE)

## Use coda to read things back into R
codaobject_m1 <- read.bugs(sens_spec.sim_m1)
model1_df <- do.call(rbind.data.frame, codaobject_m1)
```

### OpenBUGS Model 1 Posterior Distributions

```{r}
par(mfrow=c(2,2))
## Graphial summaries of posterior distributions
hist(exp(model1_df$lpi)/(1+exp(model1_df$lpi)), main="prevalence", xlab="posterior draws")
abline(v=mean(exp(model1_df$lpi)/(1+exp(model1_df$lpi))), lty="dashed", col="red")

hist(model1_df$b1, main="Age", xlab="posterior draws")
abline(v=mean(model1_df$b1), lty="dashed", col="red")
hist(model1_df$b2, main="Sex", xlab="posterior draws")
abline(v=mean(model1_df$b2), lty="dashed", col="red")
hist(model1_df$b3, main="Age/Sex Interaction", xlab="posterior draws")
abline(v=mean(model1_df$b3), lty="dashed", col="red")
```

### OpenBUGS Model 1 Disease State Classification

```{r}
## Set up storage for model results
pred_df_m1 <- data.frame(obs=1:nind,
                         D=rep(NA,nind), ## average estimate
                         SD=rep(NA,nind),
                         LB=rep(NA,nind), ## 2.5th percentile
                         UB=rep(NA,nind), ## 97.5th percentile
                         model_assignment=rep(NA,nind),
                         Clinical_status=ss_data2$ClinicalStatus,
                         Diagnostic_status=ss_data2$Diagnostically_positive)

## Calculate probabilities of compartment membership for each posterior draw
pred_df_m1$D <- apply(model1_df[,grep("D", names(model1_df))], 2, mean)
pred_df_m1$SD <- apply(model1_df[,grep("D", names(model1_df))], 2, sd)
pred_df_m1$LB <- apply(model1_df[,grep("D", names(model1_df))], 2, 
                       quantile, probs=0.025)
pred_df_m1$UB <- apply(model1_df[,grep("D", names(model1_df))], 2, 
                       quantile, probs=0.975)


summary(pred_df_m1)

## Apply a cut off of point estimate of 0.5; if pi.D > 0.5, classify as S (symptomatic), otherwise as N;
## Summarize in a table (clinical status versus diagnostic status)
table(pred_df_m1[pred_df_m1$D > 0.5,]$Clinical_status, 
      pred_df_m1[pred_df_m1$D > 0.5,]$Diagnostic_status)

## Print summary table of clinical status versus diagnostic status from the original data
table(pred_df_m1$Clinical_status, pred_df_m1$Diagnostic_status)

## boxplots
p1 <- (ggplot(data=pred_df_m1, aes(x=Diagnostic_status, y=D)) 
       + geom_boxplot()
       + theme_bw())
p2 <- (ggplot(data=pred_df_m1, aes(x=Clinical_status, y=D)) 
       + geom_boxplot()
       + theme_bw())

ggarrange(p1,p2, nrow=1)
```




## Model 2: 

The data outcome we are using is "diagnostically positive", meaning that an individual tests positive on at least one diagnostic test. This is what we have used in our other papers and seems to be popular in the literature (add some references to this). In this model, we assume that the two diagnostic tests are independent, and that there is some imprecision in the test results, so we include sensitivity and specificity for each test in the model.

### Data Model

$$
Y_k|T_{1k},T_{2k},D_k\sim Bernoulli\left(\pi_{k}^{DP} \right)
$$
We are assuming that the test outcomes are independent. The probability of a diagnostically positive test for individual $k$, $\pi_k^{DP}$, is 
\begin{align*}
\pi_k^{DP}&=P(Y_k=1|D_k)\\
&=D_k\times P(Y_k=1|D_k=1) + (1-D_k)\times (1-P(Y_k=0|D_k=0)),
\end{align*}
where
$P(Y_k=1|D_k=1)=P(T_{1k}=1|D_k=1)+P(T_{2k}=1|D_k=1)-P(T_{1k}=1|D_k=1)\times P(T_{2k}=1|D_k=1)$ and $P(Y_k=0|D_k=0)=P(T_{1k}=0|D_k=0)\times P(T_{2k}=0|D_k=0)$.

### Process Model

$$
D_k \sim Bernoulli(\delta_k)
$$
where $\delta_k=logit^{-1}(logit(\rho)+\mathbf{x}_k^T\boldsymbol{\beta})$.

### Prior Model

#### Prevalence
$$
logit(\rho) \sim Normal(\mu_{\rho}, \tau^2)
$$
where $\mu_\rho=logit^{-1}(\rho^*)$ and $\tau^2=$...

We have a range for the prevalence of (0.05, 0.10). This corresponds to a range of (`r round(log(0.05)/(1-log(0.05)),4)`, `r round(log(0.10)/(1-log(0.10)),4)`) on the logit scale. 

```{r}
hist(rnorm(10000, mean = log(0.075)/(1-log(0.075)), sd = 0.03),
     main="Logit prevalence prior distribution histogram",
     xlab="logit(prevalence)")
```

Note, the prevalence in this population may be higher - these are exposed dogs in the United States in our hunting hound population. We may want to change this, but we also want to generalize this to the larger canine population - to Brazil, if possible.

#### Linear predictors

The regression parameters are $\boldsymbol{\beta}=(\beta_{age},\beta_{sex},\beta_{age*sex})^T$;

$$
\boldsymbol{\beta}\sim Normal(\boldsymbol{\mu}_\beta,\boldsymbol{\Sigma}_\beta)
$$
where $\boldsymbol{\mu}_\beta=\mathbf{0}$ and $\boldsymbol{\Sigma}_\beta=\mathbf{I}$ in our code.


#### Other parameters:
$$
\boldsymbol{\beta}\sim Normal(\boldsymbol{\mu}_\beta, \Sigma_\beta)
$$

We will assume that the regression coefficients are independent, so $\Sigma_\beta$ is a diagonal matrix.

### OpenBUGS Model 2 Implementation
  
```{r Open Bugs Model 2, include=FALSE, message=FALSE}
## Specify data
y <- 1*(ss_data2$Diagnostically_positive=="Positive")

nind <- nrow(ss_data2)

Sex2 <- 1*(ss_data2$Sex=="M")
Age <- as.numeric(ss_data2$Age)

## problem with pi.dp
data <- list(nind=nind,
             y=y,
             Sex=Sex2,
             Age=Age,
             sens.pcr=sens.pcr,
             spec.pcr=spec.pcr,
             sens.dpp=sens.dpp,
             spec.dpp=spec.dpp,
             prev=prev,
             prec.lpi=1/0.03
)

## Initialize all prior values
inits <- function(){
  list(lpi=rnorm(1,log(prev)/(1-log(prev)), 0.03),
       b1=rnorm(0,1),
       b2=rnorm(0,1),
       b3=rnorm(0,1))
}

## Start MCMC simulation
sens_spec.sim_m2 <- bugs(data=data, 
                         inits=inits, ## FIX THIS LINE
                         model.file="Model2_diag_pos_MO.txt",
                         parameters=c("D", "lpi",
                                      "b1", "b2", "b3"),
                         n.chains=3, n.iter=10000, n.burnin=5000, 
                         codaPkg=TRUE, debug=TRUE)

## Use coda to read things back into R
codaobject_m2 <- read.bugs(sens_spec.sim_m2)
model2_df <- do.call(rbind.data.frame, codaobject_m2)
```


```{r}
par(mfrow=c(2,2))
## Graphial summaries of posterior distribtuions
hist(exp(model2_df$lpi)/(1+exp(model2_df$lpi)), main="prevalence", xlab="posterior draws")
abline(v=mean(exp(model2_df$lpi)/(1+exp(model2_df$lpi))), lty="dashed", col="red")

hist(model2_df$b1, main="Age", xlab="posterior draws")
abline(v=mean(model2_df$b1), lty="dashed", col="red")
hist(model2_df$b2, main="Sex", xlab="posterior draws")
abline(v=mean(model2_df$b2), lty="dashed", col="red")
hist(model2_df$b3, main="Age/Sex Interaction", xlab="posterior draws")
abline(v=mean(model2_df$b3), lty="dashed", col="red")

## Numeric summaries of posterior distributions
#boxplot(model2_df[,!(names(model2_df) %in% c("deviance"))])
```

The mean posterior prevalence is `r round(mean(exp(model2_df$lpi)/(1+exp(model2_df$lpi))),4)` and the 95% credible interval is: ( `r round(quantile(exp(model2_df$lpi)/(1+exp(model2_df$lpi)), prob=0.025),4)`, `r round(quantile(exp(model2_df$lpi)/(1+exp(model2_df$lpi)), prob=0.975),4)` ).

### OpenBUGS Model 2 Disease State Prediction

```{r m2 prediction}
## Set up storage for model results
pred_df_m2 <- data.frame(obs=1:nind,
                         D=rep(NA,nind), ## average estimate
                         SD=rep(NA,nind),
                         LB=rep(NA,nind), ## 2.5th percentile
                         UB=rep(NA,nind), ## 97.5th percentile
                         model_assignment=rep(NA,nind),
                         Clinical_status=ss_data2$ClinicalStatus,
                         Diagnostic_status=ss_data2$Diagnostically_positive)

## Calculate probabilities of compartment membership for each posterior draw
pred_df_m2$D <- apply(model2_df[,grep("D", names(model2_df))], 2, mean)
pred_df_m2$SD <- apply(model2_df[,grep("D", names(model2_df))], 2, sd)
pred_df_m2$LB <- apply(model2_df[,grep("D", names(model2_df))], 2, 
                       quantile, probs=0.025)
pred_df_m2$UB <- apply(model2_df[,grep("D", names(model2_df))], 2, 
                       quantile, probs=0.975)


summary(pred_df_m2)

## Apply a cut off of point estimate of 0.5; if pi.D > 0.5, classify as S (symptomatic), otherwise as N;
## Summarize in a table (clinical status versus diagnostic status)
table(pred_df_m2[pred_df_m2$D > 0.5,]$Clinical_status, 
      pred_df_m2[pred_df_m2$D > 0.5,]$Diagnostic_status)

## Print summary table of clinical status versus diagnostic status from the original data
table(pred_df_m2$Clinical_status, pred_df_m2$Diagnostic_status)

## boxplots
p1 <- (ggplot(data=pred_df_m2, aes(x=Diagnostic_status, y=D)) 
       + geom_boxplot()
       + theme_bw())
p2 <- (ggplot(data=pred_df_m2, aes(x=Clinical_status, y=D)) 
       + geom_boxplot()
       + theme_bw())

ggarrange(p1,p2, nrow=1)
```







## Model 3: 

The data outcome we are using is "diagnostically positive", meaning that an individual tests positive on at least one diagnostic test. This is what we have used in our other papers and seems to be popular in the literature (add some references to this). In this model, we assume that the two diagnostic tests are independent, and that there is some imprecision in the test results, so we include sensitivity and specificity for each test in the model. We also include a random intercept term to see how this changes the model.

### Data Model

$$
Y_k|T_{1k},T_{2k},D_k\sim Bernoulli\left(\pi_{k}^{DP} \right)
$$
We are assuming that the test outcomes are independent. The probability of a diagnostically positive test for individual $k$, $\pi_k^{DP}$, is 
\begin{align*}
\pi_k^{DP}&=P(Y_k=1|D_k)\\
&=D_k\times P(Y_k=1|D_k=1) + (1-D_k)\times (1-P(Y_k=0|D_k=0)),
\end{align*}
where
$P(Y_k=1|D_k=1)=P(T_{1k}=1|D_k=1)+P(T_{2k}=1|D_k=1)-P(T_{1k}=1|D_k=1)\times P(T_{2k}=1|D_k=1)$ and $P(Y_k=0|D_k=0)=P(T_{1k}=0|D_k=0)\times P(T_{2k}=0|D_k=0)$.

### Process Model

$$
D_k \sim Bernoulli(\delta_k)
$$
where $\delta_k=logit^{-1}(logit(\rho)+\mathbf{x}_k^T\boldsymbol{\beta}+\epsilon_k)$.

### Prior Model

#### Prevalence
$$
logit(\rho) \sim Normal(\mu_{\rho}, \tau^2)
$$
where $\mu_\rho=logit^{-1}(\rho^*)$ and $\tau^2=$...

We have a range for the prevalence of (0.05, 0.10). This corresponds to a range of (`r round(log(0.05)/(1-log(0.05)),4)`, `r round(log(0.10)/(1-log(0.10)),4)`) on the logit scale. 

```{r}
hist(rnorm(10000, mean = log(0.075)/(1-log(0.075)), sd = 0.03),
     main="Logit prevalence prior distribution histogram",
     xlab="logit(prevalence)")
```

Note, the prevalence in this population may be higher - these are exposed dogs in the United States in our hunting hound population. We may want to change this, but we also want to generalize this to the larger canine population - to Brazil, if possible.

#### Linear predictors

The regression parameters are $\boldsymbol{\beta}=(\beta_{age},\beta_{sex},\beta_{age*sex})^T$;

$$
\boldsymbol{\beta}\sim Normal(\boldsymbol{\mu}_\beta,\boldsymbol{\Sigma}_\beta)
$$
where $\boldsymbol{\mu}_\beta=\mathbf{0}$ and $\boldsymbol{\Sigma}_\beta=\mathbf{I}$ in our code.

We will assume that the regression coefficients are independent, so $\Sigma_\beta$ is a diagonal matrix.

Individual random effect - parameterized using precision.

$$
\boldsymbol{\epsilon}\sim Normal(0,5\times 10^{-3})
$$


### OpenBUGS Model 3 Implementation
  
```{r Open Bugs Model 3, include=FALSE, message=FALSE}
## Specify data
y <- 1*(ss_data2$Diagnostically_positive=="Positive")

nind <- nrow(ss_data2)

Sex2 <- 1*(ss_data2$Sex=="M")
Age <- as.numeric(ss_data2$Age)

## problem with pi.dp
data <- list(nind=nind,
             y=y,
             Sex=Sex2,
             Age=Age,
             sens.pcr=sens.pcr,
             spec.pcr=spec.pcr,
             sens.dpp=sens.dpp,
             spec.dpp=spec.dpp,
             prev=prev,
             prec.lpi=1/0.03
)

## Initialize all prior values
inits <- function(){
  list(lpi=rnorm(1,log(prev)/(1-log(prev)), 0.03),
       b1=rnorm(0,1),
       b2=rnorm(0,1),
       b3=rnorm(0,1),
       eps=rnorm(0,5.0E-03))
}

## Start MCMC simulation
sens_spec.sim_m3 <- bugs(data=data, 
                         inits=inits, ## FIX THIS LINE
                         model.file="Model3_diag_pos_rand_int_MO.txt",
                         parameters=c("D", "lpi",
                                      "b1", "b2", "b3",
                                      "eps"),
                         n.chains=3, n.iter=10000, n.burnin=5000, 
                         codaPkg=TRUE, debug=TRUE)

## Use coda to read things back into R
codaobject_m3 <- read.bugs(sens_spec.sim_m3)
model3_df <- do.call(rbind.data.frame, codaobject_m3)
```


```{r}
par(mfrow=c(2,2))
## Graphial summaries of posterior distribtuions
hist(exp(model3_df$lpi)/(1+exp(model3_df$lpi)), main="prevalence", xlab="posterior draws")
abline(v=mean(exp(model3_df$lpi)/(1+exp(model3_df$lpi))), lty="dashed", col="red")

hist(model3_df$b1, main="Age", xlab="posterior draws")
abline(v=mean(model3_df$b1), lty="dashed", col="red")
hist(model3_df$b2, main="Sex", xlab="posterior draws")
abline(v=mean(model3_df$b2), lty="dashed", col="red")
hist(model3_df$b3, main="Age/Sex Interaction", xlab="posterior draws")
abline(v=mean(model3_df$b3), lty="dashed", col="red")

## Numeric summaries of posterior distributions
#boxplot(model3_df[,!(names(model3_df) %in% c("deviance"))])
```

The mean posterior prevalence is `r round(mean(exp(model3_df$lpi)/(1+exp(model3_df$lpi))),4)` and the 95% credible interval is: ( `r round(quantile(exp(model3_df$lpi)/(1+exp(model3_df$lpi)), prob=0.025),4)`, `r round(quantile(exp(model3_df$lpi)/(1+exp(model3_df$lpi)), prob=0.975),4)` ).

### OpenBUGS Model 3 Disease State Prediction

```{r m3 prediction}
## Set up storage for model results
pred_df_m3 <- data.frame(obs=1:nind,
                         D=rep(NA,nind), ## average estimate
                         SD=rep(NA,nind),
                         LB=rep(NA,nind), ## 2.5th percentile
                         UB=rep(NA,nind), ## 97.5th percentile
                         model_assignment=rep(NA,nind),
                         Clinical_status=ss_data2$ClinicalStatus,
                         Diagnostic_status=ss_data2$Diagnostically_positive)

## Calculate probabilities of compartment membership for each posterior draw
pred_df_m3$D <- apply(model3_df[,grep("D", names(model3_df))], 2, mean)
pred_df_m3$SD <- apply(model3_df[,grep("D", names(model3_df))], 2, sd)
pred_df_m3$LB <- apply(model3_df[,grep("D", names(model3_df))], 2, 
                       quantile, probs=0.025)
pred_df_m3$UB <- apply(model3_df[,grep("D", names(model3_df))], 2, 
                       quantile, probs=0.975)


summary(pred_df_m3)

## Apply a cut off of point estimate of 0.5; if pi.D > 0.5, classify as S (symptomatic), otherwise as N;
## Summarize in a table (clinical status versus diagnostic status)
table(pred_df_m3[pred_df_m3$D > 0.5,]$Clinical_status, 
      pred_df_m3[pred_df_m3$D > 0.5,]$Diagnostic_status)

## Print summary table of clinical status versus diagnostic status from the original data
table(pred_df_m3$Clinical_status, pred_df_m3$Diagnostic_status)

## boxplots
p1 <- (ggplot(data=pred_df_m3, aes(x=Diagnostic_status, y=D)) 
       + geom_boxplot()
       + theme_bw())
p2 <- (ggplot(data=pred_df_m3, aes(x=Clinical_status, y=D)) 
       + geom_boxplot()
       + theme_bw())

ggarrange(p1,p2, nrow=1)
```
  